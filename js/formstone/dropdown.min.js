!function(e,t,i){"use strict";function n(){P=t.$body}function a(n){n.multiple=this.prop("multiple"),n.disabled=this.is(":disabled"),n.multiple?n.links=!1:n.external&&(n.links=!0);var a=this.find("[selected]").not(":disabled"),o=this.find(":selected").not(":disabled"),s=o.text(),r=this.find("option").index(o);n.multiple||""===n.label||a.length?n.label="":(o=this.prepend('<option value="" class="'+M.item_placeholder+'" selected>'+n.label+"</option>"),s=n.label,r=0);var l=this.find("option, optgroup"),u=l.filter("option");n.tabIndex=this[0].tabIndex,this[0].tabIndex=-1;var p=[M.base,n.customClass];n.mobile||t.isMobile?p.push(M.mobile):n.cover&&p.push(M.cover),n.multiple&&p.push(M.multiple),n.disabled&&p.push(M.disabled);var f='<div class="'+p.join(" ")+'" tabindex="'+n.tabIndex+'"></div>',h="";n.multiple||(h+='<button type="button" class="'+M.selected+'">',h+=e("<span></span>").text(T(s,n.trim)).html(),h+="</button>"),h+='<div class="'+M.options+'">',h+="</div>",this.wrap(f).after(h),n.$dropdown=this.parent(W.base),n.$allOptions=l,n.$options=u,n.$selected=n.$dropdown.find(W.selected),n.$wrapper=n.$dropdown.find(W.options),n.$placeholder=n.$dropdown.find(W.placeholder),n.index=-1,n.closed=!0,n.focused=!1,c(n),n.multiple||$(r,n),e.fn.fsScrollbar!==i&&n.$wrapper.fsScrollbar(),n.$selected.on(_.click,n,d),n.$dropdown.on(_.click,W.item,n,m).on(_.close,n,g),this.on(_.change,n,v),t.isMobile||(n.$dropdown.on(_.focusIn,n,b).on(_.focusOut,n,y),this.on(_.focusIn,n,function(e){e.data.$dropdown.trigger(_.raw.focusIn)}))}function o(t){t.$dropdown.hasClass(M.open)&&t.$selected.trigger(_.click),e.fn.fsScrollbar!==i&&t.$wrapper.fsScrollbar("destroy"),t.$el[0].tabIndex=t.tabIndex,t.$dropdown.off(_.namespace),t.$options.off(_.namespace),t.$placeholder.remove(),t.$selected.remove(),t.$wrapper.remove(),t.$el.off(_.namespace).show().unwrap()}function s(e,t){if("undefined"!=typeof t){var i=e.$items.index(e.$items.filter("[data-value="+t+"]"));e.$items.eq(i).addClass(M.item_disabled),e.$options.eq(i).prop("disabled",!0)}else e.$dropdown.hasClass(M.open)&&e.$selected.trigger(_.click),e.$dropdown.addClass(M.disabled),e.$el.prop("disabled",!0),e.disabled=!0}function r(e,t){if("undefined"!=typeof t){var i=e.$items.index(e.$items.filter("[data-value="+t+"]"));e.$items.eq(i).removeClass(M.item_disabled),e.$options.eq(i).prop("disabled",!1)}else e.$dropdown.removeClass(M.disabled),e.$el.prop("disabled",!1),e.disabled=!1}function l(e){var t=e.index;e.$allOptions=e.$el.find("option, optgroup"),e.$options=e.$allOptions.filter("option"),e.index=-1,t=e.$options.index(e.$options.filter(":selected")),c(e),e.multiple||$(t,e)}function c(t){for(var i="",n=0,a=0,o=t.$allOptions.length;o>a;a++){var s=t.$allOptions.eq(a),r=[];if("OPTGROUP"===s[0].tagName)r.push(M.group),s.is(":disabled")&&r.push(M.disabled),i+='<span class="'+r.join(" ")+'">'+s.attr("label")+"</span>";else{var l=s.val(),c=s.data("label");s.attr("value")||s.attr("value",l),r.push(M.item),s.hasClass(M.item_placeholder)&&r.push(M.item_placeholder),s.is(":selected")&&r.push(M.item_selected),s.is(":disabled")&&r.push(M.item_disabled),i+='<button type="button" class="'+r.join(" ")+'" ',i+='data-value="'+l+'">',i+=c?c:j.decodeEntities(T(s.text(),t.trim)),i+="</button>",n++}}t.$items=t.$wrapper.html(e.parseHTML(i)).find(W.item)}function d(e){j.killEvent(e);var i=e.data;if(!i.disabled)if(i.mobile||!t.isMobile||t.isFirefoxMobile)i.closed?p(i):f(i);else{var n=i.$el[0];if(I.createEvent){var a=I.createEvent("MouseEvents");a.initMouseEvent("mousedown",!1,!0,S,0,0,0,0,0,!1,!1,!1,!1,0,null),n.dispatchEvent(a)}else n.fireEvent&&n.fireEvent("onmousedown")}u(i)}function u(t){e(W.base).not(t.$dropdown).trigger(_.close,[t])}function p(e){if(e.closed){var t=e.$dropdown.offset(),i=P.outerHeight(),n=e.$wrapper.outerHeight(!0);e.index>=0?e.$items.eq(e.index).position():{left:0,top:0},t.top+n>i-e.bottomEdge&&e.$dropdown.addClass(M.bottom),P.on(_.click+e.dotGuid,":not("+W.options+")",e,h),e.$dropdown.trigger(_.focusIn),e.$dropdown.addClass(M.open),x(e),e.closed=!1}}function f(e){e&&!e.closed&&(P.off(_.click+e.dotGuid),e.$dropdown.removeClass([M.open,M.bottom].join(" ")),e.closed=!0)}function h(t){j.killEvent(t);var i=t.data;i&&0===e(t.currentTarget).parents(W.base).length&&(f(i),i.$dropdown.trigger(_.focusOut))}function g(e){var t=e.data;t&&(f(t),t.$dropdown.trigger(_.focusOut))}function m(t){j.killEvent(t);var i=e(this),n=t.data;if(!n.disabled){if(n.$wrapper.is(":visible")){var a=n.$items.index(i);a!==n.index&&($(a,n),C(n))}n.multiple||f(n),n.$dropdown.trigger(_.focusIn)}}function v(t,i){var n=e(this),a=t.data;if(!i&&!a.multiple){var o=a.$options.index(a.$options.filter("[value='"+H(n.val())+"']"));$(o,a),C(a)}}function b(t){j.killEvent(t);var i=(e(t.currentTarget),t.data);i.disabled||i.multiple||i.focused||(u(i),i.focused=!0,i.$dropdown.addClass(M.focus).on(_.keyDown+i.dotGuid,i,w))}function y(t){j.killEvent(t);var i=(e(t.currentTarget),t.data);i.focused&&i.closed&&(i.focused=!1,i.$dropdown.removeClass(M.focus).off(_.keyDown+i.dotGuid),i.multiple||f(i))}function w(i){var n=i.data;if(13===i.keyCode)n.closed||(f(n),$(n.index,n)),C(n);else if(!(9===i.keyCode||i.metaKey||i.altKey||i.ctrlKey||i.shiftKey)){j.killEvent(i);var a=n.$items.length-1,o=n.index<0?0:n.index;if(e.inArray(i.keyCode,t.isFirefox?[38,40,37,39]:[38,40])>-1)o+=38===i.keyCode||t.isFirefox&&37===i.keyCode?-1:1,0>o&&(o=0),o>a&&(o=a);else{var s,r,l=String.fromCharCode(i.keyCode).toUpperCase();for(r=n.index+1;a>=r;r++)if(s=n.$options.eq(r).text().charAt(0).toUpperCase(),s===l){o=r;break}if(0>o||o===n.index)for(r=0;a>=r;r++)if(s=n.$options.eq(r).text().charAt(0).toUpperCase(),s===l){o=r;break}}o>=0&&($(o,n),x(n))}}function $(e,t){var i=t.$items.eq(e),n=t.$options.eq(e),a=i.hasClass(M.item_selected),o=i.hasClass(M.item_disabled);if(!o)if(t.multiple)a?(n.prop("selected",null),i.removeClass(M.item_selected)):(n.prop("selected",!0),i.addClass(M.item_selected));else if(e>-1&&e<t.$items.length){var s=n.data("label")||i.html();t.$selected.html(s).removeClass(W.item_placeholder),t.$items.filter(W.item_selected).removeClass(M.item_selected),t.$el[0].selectedIndex=e,i.addClass(M.item_selected),t.index=e}else""!==t.label&&t.$selected.html(t.label)}function x(t){var n=t.$items.eq(t.index),a=t.index>=0&&!n.hasClass(M.item_placeholder)?n.position():{left:0,top:0},o=(t.$wrapper.outerHeight()-n.outerHeight())/2;e.fn.fsScrollbar!==i?t.$wrapper.fsScrollbar("resize").fsScrollbar("scroll",t.$wrapper.find(".fs-scrollbar-content").scrollTop()+a.top):t.$wrapper.scrollTop(t.$wrapper.scrollTop()+a.top-o)}function C(e){e.links?k(e):e.$el.trigger(_.raw.change,[!0])}function k(e){var t=e.$el.val();e.external?S.open(t):S.location.href=t}function T(e,t){return 0===t?e:e.length>t?e.substring(0,t)+"...":e}function H(e){return"string"==typeof e?e.replace(/([;&,\.\+\*\~':"\!\^#$%@\[\]\(\)=>\|])/g,"\\$1"):e}var E=t.Plugin("dropdown",{widget:!0,defaults:{bottomEdge:0,cover:!1,customClass:"",label:"",external:!1,links:!1,mobile:!1,trim:0},methods:{_setup:n,_construct:a,_destruct:o,disable:s,enable:r,update:l,open:p,close:f},classes:["cover","bottom","multiple","mobile","open","disabled","focus","selected","options","group","item","item_disabled","item_selected","item_placeholder"],events:{close:"close"}}),W=E.classes,M=W.raw,_=E.events,j=E.functions,S=t.window,I=(t.$window,t.document),P=null}(jQuery,Formstone);