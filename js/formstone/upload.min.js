!function(e,t){"use strict";function i(e){if(t.support.file){var i="";i+='<div class="'+y.target+'">',i+=e.label,i+="</div>",i+='<input class="'+y.input+'" type="file"',e.multiple&&(i+=" multiple"),i+=">",this.addClass(y.base).append(i),e.$input=this.find(b.input),e.queue=[],e.total=0,e.uploading=!1,e.disabled=!0,e.aborting=!1,this.on(w.click,b.target,e,l).on(w.dragEnter,e,d).on(w.dragOver,e,u).on(w.dragLeave,e,p).on(w.drop,b.target,e,f),e.$input.on(w.change,e,c),r.call(this,e)}}function n(e){t.support.file&&(e.$input.off(w.namespace),this.off([w.click,w.dragEnter,w.dragOver,w.dragLeave,w.drop].join(" ")).removeClass(y.base).html(""))}function a(t,i){var n;t.aborting=!0;for(var a in t.queue)t.queue.hasOwnProperty(a)&&(n=t.queue[a],("undefined"===e.type(i)||i>=0&&n.index===i)&&(n.started&&!n.complete?n.transfer.abort():o(t,n,"abort")));t.aborting=!1,g(t)}function o(e,t,i){t.error=!0,e.$el.trigger(w.fileError,[t,i]),e.aborting||g(e)}function s(e){e.disabled||(this.addClass(y.disabled),e.$input.prop("disabled",!0),e.disabled=!0)}function r(e){e.disabled&&(this.removeClass(y.disabled),e.$input.prop("disabled",!1),e.disabled=!1)}function l(e){$.killEvent(e);var t=e.data;t.disabled||t.$input.trigger(w.click)}function c(e){$.killEvent(e);var t=e.data,i=t.$input[0].files;!t.disabled&&i.length&&h(t,i)}function d(e){$.killEvent(e);var t=e.data;t.$el.addClass(y.dropping)}function u(e){$.killEvent(e);var t=e.data;t.$el.addClass(y.dropping)}function p(e){$.killEvent(e);var t=e.data;t.$el.removeClass(y.dropping)}function f(e){$.killEvent(e);var t=e.data,i=e.originalEvent.dataTransfer.files;t.$el.removeClass(y.dropping),t.disabled||h(t,i)}function h(e,t){for(var i=[],n=0;n<t.length;n++){var a={index:e.total++,file:t[n],name:t[n].name,size:t[n].size,started:!1,complete:!1,error:!1,transfer:null};i.push(a),e.queue.push(a)}e.uploading||(C.on(w.beforeUnload,function(){return e.leave}),e.uploading=!0),e.$el.trigger(w.start,[i]),g(e)}function g(e){var t=0,i=[];for(var n in e.queue)!e.queue.hasOwnProperty(n)||e.queue[n].complete||e.queue[n].error||i.push(e.queue[n]);e.queue=i;for(var a in e.queue)if(e.queue.hasOwnProperty(a)){if(!e.queue[a].started){var o=new FormData;o.append(e.postKey,e.queue[a].file);for(var s in e.postData)e.postData.hasOwnProperty(s)&&o.append(s,e.postData[s]);m(e,o,e.queue[a])}if(t++,t>=e.maxQueue)return;n++}0===t&&(C.off(w.beforeUnload),e.uploading=!1,e.$el.trigger(w.complete))}function m(t,i,n){i=t.beforeSend.call(x,i,n),n.size>=t.maxSize||i===!1||n.error===!0?o(t,n,i?"size":"abort"):(n.started=!0,n.transfer=e.ajax({url:t.action,data:i,dataType:t.dataType,type:"POST",contentType:!1,processData:!1,cache:!1,xhr:function(){var i=e.ajaxSettings.xhr();return i.upload&&i.upload.addEventListener("progress",function(e){var i=0,a=e.loaded||e.position,o=e.total;e.lengthComputable&&(i=Math.ceil(a/o*100)),t.$el.trigger(w.fileProgress,[n,i])},!1),i},beforeSend:function(){t.$el.trigger(w.fileStart,[n])},success:function(e){n.complete=!0,t.$el.trigger(w.fileComplete,[n,e]),g(t)},error:function(e,i,a){o(t,n,a)}}))}var v=t.Plugin("upload",{widget:!0,defaults:{action:"",beforeSend:function(e){return e},customClass:"",dataType:"html",label:"Drag and drop files or click to select",leave:"You have uploads pending, are you sure you want to leave this page?",maxQueue:2,maxSize:5242880,multiple:!0,postData:{},postKey:"file"},classes:["input","target","multiple","dropping","disabled"],methods:{_construct:i,_destruct:n,disable:s,enable:r,abort:a}}),b=v.classes,y=b.raw,w=v.events,$=v.functions,x=t.window,C=t.$window;w.complete="complete",w.fileStart="filestart",w.fileProgress="fileprogress",w.fileComplete="filecomplete",w.fileError="fileerror",w.start="start"}(jQuery,Formstone);