module.exports=function(e){e.registerTask("buildDocs","Build Formstone Docs.",function(){function a(e){var t={},i=e.split("\n"),n=["name","namespace","type","description","example","param","event","return","main","dependency"];for(var a in i){var o=i[a];for(var r in n){var s=n[r];if(o.indexOf("@"+s)>-1&&o.indexOf("@events")<0){var l=o.split("@"+s),c=l[l.length-1].trim();if(["param","event","return"].indexOf(s)>-1){var d=[];if("return"!==s?(d=c.split(" ",1),d.push(c.replace(d[0]+" ","")),c={name:d[0].trim()}):(d[0]="",d[1]=c,c={}),d[1]){var u=d[1].match(/\[([^\]]*)\]|\<([^\]]*)\>|\"([^\]]*)\"/g);for(var p in u){var f=u[p];0===f.indexOf("[")&&(c.type=f.replace("[","").replace("]","")),0===f.indexOf("<")&&(c["default"]=f.replace("<","").replace(">","")),0===f.indexOf('"')&&(c.description=f.replace(/"/g,""))}}}"param"===s?(t.params||(t.params=[]),t.params.push(c)):"example"===s?(t.examples||(t.examples=[]),t.examples.push(c)):"event"===s?(t.events||(t.events=[]),t.events.push(c)):"main"===s?(t.main||(t.main=[]),t.main.push(c)):"dependency"===s?(t.dependencies||(t.dependencies=[]),t.dependencies.push(c)):t[s]=c}}}return t}function o(e){var t={},i=e.split("\n"),n=["name","description","type"];for(var a in i){var o=i[a];for(var r in n){var s=n[r];if(o.indexOf("@"+s)>-1){var l=o.split("@"+s),c=l[l.length-1].trim();t[s]=c}}}return t}function r(r){var m,s={main:[]},l=r,c=r.replace(/js/g,"less"),d=r.replace("src/js","src/docs").replace("src/less","src/docs").replace(/js/g,"md").replace(/less/g,"md"),u=r.replace("src/js","src/docs").replace("src/less","src/docs").replace(/js/g,"html").replace(/less/g,"html"),p=e.file.exists(l)?e.file.read(l):!1,f=e.file.exists(c)?e.file.read(c):!1,h=e.file.exists(d)?e.file.read(d):!1,g=e.file.exists(u)?e.file.read(u):!1;if(f&&(m=r.replace("src/less","docs/json").replace(".less",".json")),p&&c!==r&&(m=r.replace("src/js","docs/json").replace(".js",".json")),p){var v=p.match(/(?:\/\*(?:[^*]|(?:\*+[^*\/]))*\*+\/)/g);if(s.options=[],s.events=[],s.methods=[],v)for(var b=0,y=v.length;y>b;b++){var w=v[b];if(w.indexOf("@plugin")>-1){var $=a(w);s.name=$.name,s.namespace=$.namespace,s.type=$.type,s.description=$.description,s.main=$.main,s.dependencies=$.dependencies}else if(w.indexOf("@options")>-1){var x=a(w);s.options=x.params}else if(w.indexOf("@events")>-1){var C=a(w);s.events=C.events}else if(w.indexOf("@method")>-1){s.methods||(s.methods=[]);var k=a(w);w.indexOf("private")<0&&(w.indexOf("@method widget")>-1?t.push(k):w.indexOf("@method utility")>-1?i.push(k):s.methods.push(k))}}}if(f){var T=f.match(/(?:\/\*(?:[^*]|(?:\*+[^*\/]))*\*+\/)/g);if(s.css=[],T)for(var b=0,y=T.length;y>b;b++){var w=T[b];if(w.indexOf("@class")>-1){var H=o(w);H.name&&s.css.push(H)}else if(w.indexOf("@grid")>-1){var W=o(w);s.name=W.name,s.namespace=W.namespace,s.type="grid",s.description=W.description}}}if(s.name){var E=s.name.toLowerCase();if(p){if("formstone"!==E&&"core"!==E&&"grid"!==E){if("widget"===s.type)for(var b in t){var k=JSON.parse(JSON.stringify(t[b]));if(k.examples)for(var M in k.examples)k.examples[M]=k.examples[M].replace("{ns}",E);s.methods.push(k)}for(var b in i){var k=JSON.parse(JSON.stringify(i[b]));if(k.examples)for(var M in k.examples)k.examples[M]=k.examples[M].replace("{ns}",E);s.methods.push(k)}}s.methods.sort(function(e,t){return e.name<t.name?-1:e.name>t.name?1:0})}h&&(s.use=h),g&&(s.demo=g),e.file.write(m,JSON.stringify(s)),e.log.writeln('File "'+m+'" created.'),n[s.type]&&n[s.type].push(s)}}function s(e,t,i){var n=e.name.toLowerCase(),a="";if(a+=t+" "+e.name,a+="\n\n",a+=e.description,a+="\n\n",i&&e.demo&&(a+="* [Demo](#demo)",a+="\n"),a+="* [Use](#use)",a+="\n",e.options&&e.options.length&&(a+="* [Options](#options)",a+="\n"),e.events&&e.events.length&&(a+="* [Events](#events)",a+="\n"),e.methods&&e.methods.length&&(a+="* [Methods](#methods)",a+="\n"),e.css&&e.css.length&&(a+="* [CSS](#css)",a+="\n"),i&&(a+='<br class="split">\n'),a+="\n",a+=t+"# Use ",a+="\n\n",e.main&&e.main.length){a+=t+"### Main",a+="\n\n",a+="```markup",a+="\n";for(var o in e.main)a+=e.main[o],a+="\n";a+="```",a+="\n\n"}if(e.dependencies&&e.dependencies.length){a+=t+"### Dependencies",a+="\n\n",a+="```markup",a+="\n";for(var o in e.dependencies)a+=e.dependencies[o],a+="\n";a+="```",a+="\n\n"}if(e.use&&(a+=e.use,a+="\n\n"),e.options&&e.options.length){a+=t+"# Options",a+="\n\n","widget"===e.type&&(a+="Set instance options by passing a valid object at initialization, or to the public `defaults` method. Custom options for a specific instance can also be set by attaching a `data-"+n+"-options` attribute to the target elment. This attribute should contain the properly formatted JSON object representing the custom options."),"utility"===e.type&&(a+="Set instance options by passing a valid object at initialization, or to the public `defaults` method."),a+="\n\n",a+="| Name | Type | Default | Description |",a+="\n",a+="| --- | --- | --- | --- |",a+="\n";for(var o in e.options){var r=e.options[o];a+="| "+(r.name?"`"+r.name+"`":"&nbsp;"),a+=" | "+(r.type?"`"+r.type+"`":"&nbsp;"),a+=" | "+(r["default"]?"`"+r["default"]+"`":"&nbsp;"),a+=" | "+(r.description||"&nbsp;"),a+=" |\n"}a+="\n"}if(e.events&&e.events.length){a+=t+"# Events",a+="\n\n","widget"===e.type&&(a+="Events are triggered on the target instance's element, unless otherwise stated.",a+="\n\n"),"utility"===e.type&&(a+="Events are triggered on the `window`, unless otherwise stated.",a+="\n\n"),a+="| Event | Description |",a+="\n",a+="| --- | --- |",a+="\n";for(var o in e.events){var s=e.events[o];a+="| "+(s.name?"`"+s.name+"`":"&nbsp;"),a+=" | "+(s.description||"&nbsp;"),a+=" |\n"}a+="\n"}if(e.methods&&e.methods.length){a+=t+"# Methods",a+="\n\n","widget"===e.type&&(a+="Methods are publicly available to all active instances, unless otherwise stated.",a+="\n\n"),"utility"===e.type&&(a+="Methods are publicly available, unless otherwise stated.",a+="\n\n");for(var o in e.methods){var l=e.methods[o];if(a+=t+"## "+l.name,a+="\n\n",a+=l.description,a+="\n\n",l.examples&&l.examples.length)for(var c in l.examples)a+="```javascript",a+="\n",a+=l.examples[c],a+="\n",a+="```",a+="\n";if(a+="\n",l.params&&l.params.length){a+=t+"### Parameters",a+="\n\n",a+="| Name | Type | Default | Description |",a+="\n",a+="| --- | --- | --- | --- |",a+="\n";for(var c in l.params){var d=l.params[c];a+="| "+(d.name?"`"+d.name+"`":"&nbsp;"),a+=" | "+(d.type?"`"+d.type+"`":"&nbsp;"),a+=" | "+(d["default"]?"`"+d["default"]+"`":"&nbsp;"),a+=" | "+(d.description||"&nbsp;"),a+=" |\n"}a+="\n"}}}if(e.css&&e.css.length){a+=t+"# CSS",a+="\n\n",a+="| Class | Type | Description |",a+="\n",a+="| --- | --- | --- |",a+="\n";for(var o in e.css){var u=e.css[o];a+="| "+(u.name?"`"+u.name+"`":"&nbsp;"),a+=" | "+(u.type?"`"+u.type+"`":"&nbsp;"),a+=" | "+(u.description||"&nbsp;"),a+=" |\n"}a+="\n"}return a}function l(t){var i=e.file.readJSON(t),n=t.replace("/json","").replace(".json",".md"),a=s(i,"#");e.file.write(n,a,!1),e.log.writeln('File "'+n+'" created.')}function c(t){var i=e.file.readJSON(t),n=t.replace("docs/json","demo/pages/components").replace(".json",".md"),a=n.replace("demo/pages/components","demo/templates/partials/components"),o=s(i,"#",!0),r=o.split('<br class="split">'),l={template:"component.html",title:i.name,demo:i.demo,bottom:"components/"+i.name.toLowerCase().replace(/ /g,""),site_root:"../",asset_root:"../../",component_root:"../../components/"};e.file.write(n,JSON.stringify(l)+"\n\n"+r[0]),e.file.write(a,r[1]),e.log.writeln('File "'+n+'" created.')}function d(){var t="";t+="## Library",t+="\n\n",t+="* [Core](core.md)",t+="\n";for(var i in n.grid){var a=n.grid[i];t+="* ["+a.name+"]("+a.name.toLowerCase().replace(/ /g,"")+".md)",t+="\n"}t+="\n",t+="## Utility",t+="\n\n";for(var i in n.utility){var a=n.utility[i];t+="* ["+a.name+"]("+a.name.toLowerCase().replace(/ /g,"")+".md)",t+="\n"}t+="\n",t+="## Widget",t+="\n\n";for(var i in n.widget){var a=n.widget[i];t+="* ["+a.name+"]("+a.name.toLowerCase().replace(/ /g,"")+".md)",t+="\n"}e.file.write("docs/README.md","# Documentation \n\n"+t)}function u(){var t="",i="",a="";i+="<h5>About</h5>",i+="<ul>",i+='<li><a href="{{= it.site_root }}start.html" data-analytics-event="MainNav, Click, start">Getting Started</a></li>',i+='<li><a href="{{= it.site_root }}upgrade.html" data-analytics-event="MainNav, Click, upgrade">Upgrade Guide</a></li>',i+='<li><a href="{{= it.site_root }}contribute.html" data-analytics-event="MainNav, Click, contribute">Contributing</a></li>',i+="</ul>",i+="<h5>Library</h5>",i+="<ul>",i+='<li><a href="{{= it.component_root }}core.html" data-analytics-event="MainNav, Click, core">Core</a></li>';for(var o in n.grid){var r=n.grid[o],s=r.name.toLowerCase().replace(/ /g,"");i+='<li><a href="{{= it.component_root }}'+s+'.html" data-analytics-event="MainNav, Click, '+s+'">'+r.name+"</a></li>"}i+="</ul>",i+="<h5>Utility</h5>",i+="<ul>";for(var o in n.utility){var r=n.utility[o],s=r.name.toLowerCase().replace(/ /g,"");i+='<li><a href="{{= it.component_root }}'+s+'.html" data-analytics-event="MainNav, Click, '+s+'">'+r.name+"</a></li>"}i+="</ul>",i+="<h5>Widget</h5>",i+="<ul>";for(var o in n.widget){var r=n.widget[o],s=r.name.toLowerCase().replace(/ /g,"");i+='<li><a href="{{= it.component_root }}'+s+'.html" data-analytics-event="MainNav, Click, '+s+'">'+r.name+"</a></li>"}i+="</ul>",e.file.write("demo/templates/partials/navigation.html",i),t+="<h2>Library</h2>",t+='<div class="listing">',t+='<a href="{{= it.component_root }}core.html">Core</a>';for(var o in n.grid){var r=n.grid[o],s=r.name.toLowerCase().replace(/ /g,"");t+='<a href="{{= it.component_root }}'+s+'.html" data-analytics-event="ComponentNav, Click, '+s+'">'+r.name+"</a>"}t+="</div>",t+="<h2>Utility</h2>",t+='<div class="listing">';for(var o in n.utility){var r=n.utility[o],s=r.name.toLowerCase().replace(/ /g,"");t+='<a href="{{= it.component_root }}'+s+'.html" data-analytics-event="ComponentNav, Click, '+s+'">'+r.name+"</a>"}t+="</div>",t+="<h2>Widget</h2>",t+='<div class="listing">';for(var o in n.widget){var r=n.widget[o],s=r.name.toLowerCase().replace(/ /g,"");t+='<a href="{{= it.component_root }}'+s+'.html" data-analytics-event="ComponentNav, Click, '+s+'">'+r.name+"</a>"}t+="</div>",e.file.write("demo/templates/partials/component-list.html",t),e.file.write("demo/pages/components/default.md",'{"template":"components.html","title":"Components","site_root":"../","asset_root":"../","component_root":"../components/"}'),a+='<?xml version="1.0" encoding="UTF-8" ?>\n',a+='<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n',a+="<url><loc>http://formstone.it/</loc></url>\n",a+="<url><loc>http://formstone.it/start/</loc></url>\n",a+="<url><loc>http://formstone.it/upgrade/</loc></url>\n",a+="<url><loc>http://formstone.it/contribute/</loc></url>\n",a+="<url><loc>http://formstone.it/components/</loc></url>\n";for(var o in n.grid){var r=n.grid[o];a+="<url><loc>http://formstone.it/components/"+r.name.toLowerCase().replace(/ /g,"")+"</loc></url>\n"}for(var o in n.utility){var r=n.utility[o];a+="<url><loc>http://formstone.it/components/"+r.name.toLowerCase().replace(/ /g,"")+"</loc></url>\n"}for(var o in n.widget){var r=n.widget[o];a+="<url><loc>http://formstone.it/components/"+r.name.toLowerCase().replace(/ /g,"")+"</loc></url>\n"}a+="</urlset>\n",e.file.write("demo/sitemap.xml",a)}var t=[],i=[],n={grid:[],utility:[],widget:[]};e.file.expand("src/js/*.js").forEach(r),e.file.expand("src/less/*.less").forEach(r),e.file.expand("docs/json/*.json").forEach(l),e.file.expand("docs/json/*.json").forEach(c),d(),u();var p=e.file.readJSON("package.json"),f="README.md",h='<a href="http://gruntjs.com" target="_blank"><img src="https://cdn.gruntjs.com/builtwith.png" alt="Built with Grunt"></a> \n<a href="http://badge.fury.io/bo/formstone"><img src="https://badge.fury.io/bo/formstone.svg" alt="Bower version"></a> \n<a href="https://travis-ci.org/Formstone/Formstone"><img src="https://travis-ci.org/Formstone/Formstone.svg?branch=master" alt="Travis CI"></a> \n\n# '+p.realname+" \n\n"+p.description+" \n\n[Documentation](docs/README.md) <br>[Changelog](CHANGELOG.md)";e.file.write(f,h),e.log.writeln('File "'+f+'" created.');var g=e.file.read("CHANGELOG.md"),f="demo/pages/changelog.md",h='{"template":"content.html","title":"Changelog","site_root":"../","asset_root":"../","component_root":"../components/"} \n\n'+g;e.file.write(f,h),e.log.writeln('File "'+f+'" created.')})};