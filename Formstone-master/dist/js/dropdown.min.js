!function(e,t,n){"use strict";function i(){D=t.$body}function o(i){i.multiple=this.prop("multiple"),i.disabled=this.is(":disabled"),i.multiple?i.links=!1:i.external&&(i.links=!0);var o=this.find("[selected]").not(":disabled"),a=this.find(":selected").not(":disabled"),r=a.text(),s=this.find("option").index(a);i.multiple||""===i.label||o.length?i.label="":(a=this.prepend('<option value="" class="'+H.item_placeholder+'" selected>'+i.label+"</option>"),r=i.label,s=0);var l=this.find("option, optgroup"),u=l.filter("option");i.tabIndex=this[0].tabIndex,this[0].tabIndex=-1;var p=[H.base,i.customClass];i.mobile||t.isMobile?p.push(H.mobile):i.cover&&p.push(H.cover),i.multiple&&p.push(H.multiple),i.disabled&&p.push(H.disabled);var f='<div class="'+p.join(" ")+'" tabindex="'+i.tabIndex+'"></div>',h="";i.multiple||(h+='<button type="button" class="'+H.selected+'">',h+=e("<span></span>").text(k(r,i.trim)).html(),h+="</button>"),h+='<div class="'+H.options+'">',h+="</div>",this.wrap(f).after(h),i.$dropdown=this.parent(j.base),i.$allOptions=l,i.$options=u,i.$selected=i.$dropdown.find(j.selected),i.$wrapper=i.$dropdown.find(j.options),i.$placeholder=i.$dropdown.find(j.placeholder),i.index=-1,i.closed=!0,i.focused=!1,c(i),i.multiple||$(s,i),e.fn.fsScrollbar!==n&&i.$wrapper.fsScrollbar(),i.$selected.on(_.click,i,d),i.$dropdown.on(_.click,j.item,i,g).on(_.close,i,m),this.on(_.change,i,v),t.isMobile||(i.$dropdown.on(_.focusIn,i,y).on(_.focusOut,i,b),this.on(_.focusIn,i,function(e){e.data.$dropdown.trigger(_.raw.focusIn)}))}function a(t){t.$dropdown.hasClass(H.open)&&t.$selected.trigger(_.click),e.fn.fsScrollbar!==n&&t.$wrapper.fsScrollbar("destroy"),t.$el[0].tabIndex=t.tabIndex,t.$dropdown.off(_.namespace),t.$options.off(_.namespace),t.$placeholder.remove(),t.$selected.remove(),t.$wrapper.remove(),t.$el.off(_.namespace).show().unwrap()}function r(e,t){if("undefined"!=typeof t){var n=e.$items.index(e.$items.filter("[data-value="+t+"]"));e.$items.eq(n).addClass(H.item_disabled),e.$options.eq(n).prop("disabled",!0)}else e.$dropdown.hasClass(H.open)&&e.$selected.trigger(_.click),e.$dropdown.addClass(H.disabled),e.$el.prop("disabled",!0),e.disabled=!0}function s(e,t){if("undefined"!=typeof t){var n=e.$items.index(e.$items.filter("[data-value="+t+"]"));e.$items.eq(n).removeClass(H.item_disabled),e.$options.eq(n).prop("disabled",!1)}else e.$dropdown.removeClass(H.disabled),e.$el.prop("disabled",!1),e.disabled=!1}function l(e){var t=e.index;e.$allOptions=e.$el.find("option, optgroup"),e.$options=e.$allOptions.filter("option"),e.index=-1,t=e.$options.index(e.$options.filter(":selected")),c(e),e.multiple||$(t,e)}function c(t){for(var n="",i=0,o=0,a=t.$allOptions.length;a>o;o++){var r=t.$allOptions.eq(o),s=[];if("OPTGROUP"===r[0].tagName)s.push(H.group),r.is(":disabled")&&s.push(H.disabled),n+='<span class="'+s.join(" ")+'">'+r.attr("label")+"</span>";else{var l=r.val(),c=r.data("label");r.attr("value")||r.attr("value",l),s.push(H.item),r.hasClass(H.item_placeholder)&&s.push(H.item_placeholder),r.is(":selected")&&s.push(H.item_selected),r.is(":disabled")&&s.push(H.item_disabled),n+='<button type="button" class="'+s.join(" ")+'" ',n+='data-value="'+l+'">',n+=c?c:M.decodeEntities(k(r.text(),t.trim)),n+="</button>",i++}}t.$items=t.$wrapper.html(e.parseHTML(n)).find(j.item)}function d(e){M.killEvent(e);var n=e.data;if(!n.disabled)if(n.mobile||!t.isMobile||t.isFirefoxMobile)n.closed?p(n):f(n);else{var i=n.$el[0];if(W.createEvent){var o=W.createEvent("MouseEvents");o.initMouseEvent("mousedown",!1,!0,N,0,0,0,0,0,!1,!1,!1,!1,0,null),i.dispatchEvent(o)}else i.fireEvent&&i.fireEvent("onmousedown")}u(n)}function u(t){e(j.base).not(t.$dropdown).trigger(_.close,[t])}function p(e){if(e.closed){var t=e.$dropdown.offset(),n=D.outerHeight(),i=e.$wrapper.outerHeight(!0);e.index>=0?e.$items.eq(e.index).position():{left:0,top:0},t.top+i>n-e.bottomEdge&&e.$dropdown.addClass(H.bottom),D.on(_.click+e.dotGuid,":not("+j.options+")",e,h),e.$dropdown.trigger(_.focusIn),e.$dropdown.addClass(H.open),x(e),e.closed=!1}}function f(e){e&&!e.closed&&(D.off(_.click+e.dotGuid),e.$dropdown.removeClass([H.open,H.bottom].join(" ")),e.closed=!0)}function h(t){M.killEvent(t);var n=t.data;n&&0===e(t.currentTarget).parents(j.base).length&&(f(n),n.$dropdown.trigger(_.focusOut))}function m(e){var t=e.data;t&&(f(t),t.$dropdown.trigger(_.focusOut))}function g(t){M.killEvent(t);var n=e(this),i=t.data;if(!i.disabled){if(i.$wrapper.is(":visible")){var o=i.$items.index(n);o!==i.index&&($(o,i),C(i))}i.multiple||f(i),i.$dropdown.trigger(_.focusIn)}}function v(t,n){var i=e(this),o=t.data;if(!n&&!o.multiple){var a=o.$options.index(o.$options.filter("[value='"+E(i.val())+"']"));$(a,o),C(o)}}function y(t){M.killEvent(t);var n=(e(t.currentTarget),t.data);n.disabled||n.multiple||n.focused||(u(n),n.focused=!0,n.$dropdown.addClass(H.focus).on(_.keyDown+n.dotGuid,n,w))}function b(t){M.killEvent(t);var n=(e(t.currentTarget),t.data);n.focused&&n.closed&&(n.focused=!1,n.$dropdown.removeClass(H.focus).off(_.keyDown+n.dotGuid),n.multiple||f(n))}function w(n){var i=n.data;if(13===n.keyCode)i.closed||(f(i),$(i.index,i)),C(i);else if(!(9===n.keyCode||n.metaKey||n.altKey||n.ctrlKey||n.shiftKey)){M.killEvent(n);var o=i.$items.length-1,a=i.index<0?0:i.index;if(e.inArray(n.keyCode,t.isFirefox?[38,40,37,39]:[38,40])>-1)a+=38===n.keyCode||t.isFirefox&&37===n.keyCode?-1:1,0>a&&(a=0),a>o&&(a=o);else{var r,s,l=String.fromCharCode(n.keyCode).toUpperCase();for(s=i.index+1;o>=s;s++)if(r=i.$options.eq(s).text().charAt(0).toUpperCase(),r===l){a=s;break}if(0>a||a===i.index)for(s=0;o>=s;s++)if(r=i.$options.eq(s).text().charAt(0).toUpperCase(),r===l){a=s;break}}a>=0&&($(a,i),x(i))}}function $(e,t){var n=t.$items.eq(e),i=t.$options.eq(e),o=n.hasClass(H.item_selected),a=n.hasClass(H.item_disabled);if(!a)if(t.multiple)o?(i.prop("selected",null),n.removeClass(H.item_selected)):(i.prop("selected",!0),n.addClass(H.item_selected));else if(e>-1&&e<t.$items.length){var r=i.data("label")||n.html();t.$selected.html(r).removeClass(j.item_placeholder),t.$items.filter(j.item_selected).removeClass(H.item_selected),t.$el[0].selectedIndex=e,n.addClass(H.item_selected),t.index=e}else""!==t.label&&t.$selected.html(t.label)}function x(t){var i=t.$items.eq(t.index),o=t.index>=0&&!i.hasClass(H.item_placeholder)?i.position():{left:0,top:0},a=(t.$wrapper.outerHeight()-i.outerHeight())/2;e.fn.fsScrollbar!==n?t.$wrapper.fsScrollbar("resize").fsScrollbar("scroll",t.$wrapper.find(".fs-scrollbar-content").scrollTop()+o.top):t.$wrapper.scrollTop(t.$wrapper.scrollTop()+o.top-a)}function C(e){e.links?T(e):e.$el.trigger(_.raw.change,[!0])}function T(e){var t=e.$el.val();e.external?N.open(t):N.location.href=t}function k(e,t){return 0===t?e:e.length>t?e.substring(0,t)+"...":e}function E(e){return"string"==typeof e?e.replace(/([;&,\.\+\*\~':"\!\^#$%@\[\]\(\)=>\|])/g,"\\$1"):e}var S=t.Plugin("dropdown",{widget:!0,defaults:{bottomEdge:0,cover:!1,customClass:"",label:"",external:!1,links:!1,mobile:!1,trim:0},methods:{_setup:i,_construct:o,_destruct:a,disable:r,enable:s,update:l,open:p,close:f},classes:["cover","bottom","multiple","mobile","open","disabled","focus","selected","options","group","item","item_disabled","item_selected","item_placeholder"],events:{close:"close"}}),j=S.classes,H=j.raw,_=S.events,M=S.functions,N=t.window,W=(t.$window,t.document),D=null}(jQuery,Formstone);