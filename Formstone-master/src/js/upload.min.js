!function(e,t,i){"use strict";function n(e){if(t.support.file){var i="";i+='<div class="'+w.target+'">',i+=e.label,i+="</div>",i+='<input class="'+w.input+'" type="file"',e.multiple&&(i+=" multiple"),i+=">",this.addClass(w.base).append(i),e.$input=this.find(y.input),e.queue=[],e.total=0,e.uploading=!1,e.disabled=!0,e.aborting=!1,this.on($.click,y.target,e,c).on($.dragEnter,e,u).on($.dragOver,e,p).on($.dragLeave,e,f).on($.drop,y.target,e,h),e.$input.on($.change,e,d),l.call(this,e)}}function a(e){t.support.file&&(e.$input.off($.namespace),this.off([$.click,$.dragEnter,$.dragOver,$.dragLeave,$.drop].join(" ")).removeClass(w.base).html(""))}function o(t,i){var n;t.aborting=!0;for(var a in t.queue)t.queue.hasOwnProperty(a)&&(n=t.queue[a],("undefined"===e.type(i)||i>=0&&n.index===i)&&(n.started&&!n.complete?n.transfer.abort():r(t,n,"abort")));t.aborting=!1,m(t)}function r(e,t,i){t.error=!0,e.$el.trigger($.fileError,[t,i]),e.aborting||m(e)}function s(e){e.disabled||(this.addClass(w.disabled),e.$input.prop("disabled",!0),e.disabled=!0)}function l(e){e.disabled&&(this.removeClass(w.disabled),e.$input.prop("disabled",!1),e.disabled=!1)}function c(e){x.killEvent(e);var t=e.data;t.disabled||t.$input.trigger($.click)}function d(e){x.killEvent(e);var t=e.data,i=t.$input[0].files;!t.disabled&&i.length&&g(t,i)}function u(e){x.killEvent(e);var t=e.data;t.$el.addClass(w.dropping)}function p(e){x.killEvent(e);var t=e.data;t.$el.addClass(w.dropping)}function f(e){x.killEvent(e);var t=e.data;t.$el.removeClass(w.dropping)}function h(e){x.killEvent(e);var t=e.data,i=e.originalEvent.dataTransfer.files;t.$el.removeClass(w.dropping),t.disabled||g(t,i)}function g(e,t){for(var i=[],n=0;n<t.length;n++){var a={index:e.total++,file:t[n],name:t[n].name,size:t[n].size,started:!1,complete:!1,error:!1,transfer:null};i.push(a),e.queue.push(a)}e.uploading||(k.on($.beforeUnload,function(){return e.leave}),e.uploading=!0),e.$el.trigger($.start,[i]),m(e)}function m(e){var t=0,i=[];for(var n in e.queue)!e.queue.hasOwnProperty(n)||e.queue[n].complete||e.queue[n].error||i.push(e.queue[n]);e.queue=i;for(var a in e.queue)if(e.queue.hasOwnProperty(a)){if(!e.queue[a].started){var o=new FormData;o.append(e.postKey,e.queue[a].file);for(var r in e.postData)e.postData.hasOwnProperty(r)&&o.append(r,e.postData[r]);v(e,o,e.queue[a])}if(t++,t>=e.maxQueue)return;n++}0===t&&(k.off($.beforeUnload),e.uploading=!1,e.$el.trigger($.complete))}function v(t,i,n){i=t.beforeSend.call(C,i,n),n.size>=t.maxSize||i===!1||n.error===!0?r(t,n,i?"size":"abort"):(n.started=!0,n.transfer=e.ajax({url:t.action,data:i,dataType:t.dataType,type:"POST",contentType:!1,processData:!1,cache:!1,xhr:function(){var i=e.ajaxSettings.xhr();return i.upload&&i.upload.addEventListener("progress",function(e){var i=0,a=e.loaded||e.position,o=e.total;e.lengthComputable&&(i=Math.ceil(a/o*100)),t.$el.trigger($.fileProgress,[n,i])},!1),i},beforeSend:function(e,i){t.$el.trigger($.fileStart,[n])},success:function(e,i,a){n.complete=!0,t.$el.trigger($.fileComplete,[n,e]),m(t)},error:function(e,i,a){r(t,n,a)}}))}var b=t.Plugin("upload",{widget:!0,defaults:{action:"",beforeSend:function(e){return e},customClass:"",dataType:"html",label:"Drag and drop files or click to select",leave:"You have uploads pending, are you sure you want to leave this page?",maxQueue:2,maxSize:5242880,multiple:!0,postData:{},postKey:"file"},classes:["input","target","multiple","dropping","disabled"],methods:{_construct:n,_destruct:a,disable:s,enable:l,abort:o}}),y=b.classes,w=y.raw,$=b.events,x=b.functions,C=t.window,k=t.$window;$.complete="complete",$.fileStart="filestart",$.fileProgress="fileprogress",$.fileComplete="filecomplete",$.fileError="fileerror",$.start="start"}(jQuery,Formstone);